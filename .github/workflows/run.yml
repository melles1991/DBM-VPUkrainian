name: Auto GitHub Release

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get version from .toc file
        id: get_version
        run: |
          # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð±Ð°Ð·Ð¾Ð²Ñƒ Ð²ÐµÑ€ÑÑ–ÑŽ Ð· .toc Ñ„Ð°Ð¹Ð»Ñƒ (Ð¿ÐµÑ€ÑˆÑ– Ð´Ð²Ð° Ñ‡Ð¸ÑÐ»Ð° Ð²ÐµÑ€ÑÑ–Ñ—)
          BASE_VERSION=$(grep -oP '^## Version: \K.*' DBM-VPUkrainian.toc | cut -d '.' -f1,2)
          # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð·Ð±Ñ–Ñ€ÐºÐ¸
          BUILD_NUMBER=${{ github.run_number }}  
          # Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ Ñ„Ñ–Ð½Ð°Ð»ÑŒÐ½Ñƒ Ð²ÐµÑ€ÑÑ–ÑŽ
          FINAL_VERSION="v${BASE_VERSION}.${BUILD_NUMBER}"
          
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_ENV  # Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ FINAL_VERSION Ñƒ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ñ–
          echo "version=$FINAL_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð° Ð²ÐµÑ€ÑÑ–Ñ Ð· TOC: $BASE_VERSION"
          echo "Ð‘ÑƒÐ´Ñ–Ð²ÐµÐ»ÑŒÐ½Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€: $BUILD_NUMBER"
          echo "ÐÐ¾Ð²Ð° Ð²ÐµÑ€ÑÑ–Ñ (Ð· Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ Ð·Ð±Ñ–Ñ€ÐºÐ¸): $FINAL_VERSION"
          
      - name: Get previous tag (if any)
        id: get_latest
        run: |
          # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¹ Ñ‚ÐµÐ³ Ð°Ð±Ð¾ Ð²ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÐ¾Ð²Ð¸Ð¹ "v0.0.0" ÑÐºÑ‰Ð¾ Ñ‚ÐµÐ³Ñ–Ð² Ð½ÐµÐ¼Ð°Ñ”
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo ${{ steps.get_version.outputs.version }})
          echo "latest=$tag" >> $GITHUB_OUTPUT
          echo "ÐŸÐ¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¹ Ñ‚ÐµÐ³: $tag"

      - name: Create Git tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð½Ð¾Ð²Ð¸Ð¹ Ñ‚ÐµÐ³ Ð· FINAL_VERSION
          git tag ${{ steps.get_version.outputs.version }}
          git push origin ${{ steps.get_version.outputs.version }}

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
